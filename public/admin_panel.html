<!DOCTYPE html>
<html lang="pl" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .product-form {
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .delete-btn, .edit-btn {
            float: right;
            cursor: pointer;
            margin-left: 10px;
        }
        .delete-btn {
            color: #ff4444;
        }
        .edit-btn {
            color: #0d6efd;
        }
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .card-body {
                padding: 15px;
            }
            .row.g-3 {
                gap: 10px !important;
            }
            .col-md-4, .col-md-6, .col-md-2 {
                width: 100%;
            }
        }
        /* Animacje */
        .list-group-item {
            background-color: #ffffff;
            color: #000000;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .list-group-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Style dla ciemnego motywu */
        [data-bs-theme="dark"] {
            background-color: #212529;
            color: #fff;
        }
        [data-bs-theme="dark"] .product-form {
            background-color: #2c3034;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .card {
            background-color: #2c3034;
            border-color: #373b3e;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .form-control {
            background-color: #212529;
            border-color: #373b3e;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .form-control:focus {
            background-color: #2c3034;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .form-select {
            background-color: #212529;
            border-color: #373b3e;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .modal-content {
            background-color: #2c3034;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .modal-header {
            border-bottom-color: #373b3e;
        }
        [data-bs-theme="dark"] .modal-footer {
            border-top-color: #373b3e;
        }
        [data-bs-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .description-line {
            margin: 5px 0;
            color: inherit;
        }
        .nav-tabs .nav-link {
            color: #4a90e2;
            border: none;
            padding: 10px 20px;
            margin-right: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-tabs .nav-link.active {
            background-color: #4a90e2;
            color: white;
        }

        .nav-tabs .nav-link:hover {
            background-color: #357abd;
            color: white;
        }

        .review-box {
            background-color: #1a1a1a;
            border: 1px solid #4a90e2;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }

        .review-box .delete-review {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .review-box .delete-review:hover {
            background-color: #c82333;
        }

        .review-box .stars {
            color: #ffd700;
            margin: 10px 0;
        }

        .review-box .review-date {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Przełącznik motywu -->
    <div class="theme-switch">
        <button class="btn btn-outline-primary" id="themeToggle">
            <i class="bi bi-moon-stars"></i> Zmień motyw
        </button>
    </div>

    <!-- Modal do wprowadzania hasła -->
    <div class="modal fade" id="adminPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Autoryzacja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="adminPasswordForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="adminPasswordInput" class="form-label">Podaj hasło administratora:</label>
                            <input type="password" class="form-control" id="adminPasswordInput" required>
                        </div>
                        <input type="hidden" id="adminActionType" value="add">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary">Potwierdź</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal do edycji produktu -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edytuj produkt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editProductForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Typ produktu</label>
                            <select class="form-select" id="editProductType" required>
                                <option value="steam">Konto Steam</option>
                                <option value="instagram">Konto Instagram</option>
                                <option value="facebook">Konto Facebook</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editProductName" class="form-label">Nazwa produktu</label>
                            <input type="text" class="form-control" id="editProductName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Opis produktu</label>
                            <small class="form-text text-muted d-block">Każdą linię opisu zacznij od "✦ ". Przykład:<br>✦ Długa historia<br>✦ Pełna weryfikacja<br>✦ Gwarancja bezpieczeństwa</small>
                            <textarea class="form-control mt-2" id="editProductDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editProductPrice" class="form-label">Cena (PLN)</label>
                            <input type="number" class="form-control" id="editProductPrice" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editProductPromotion" onchange="toggleEditPromotionFields()">
                                <label class="form-check-label" for="editProductPromotion">
                                    Włącz promocję
                                </label>
                            </div>
                        </div>
                        <div id="editPromotionFields" style="display: none;">
                            <div class="mb-3">
                                <label for="editPromotionPrice" class="form-label">Cena promocyjna (PLN)</label>
                                <input type="number" class="form-control" id="editPromotionPrice">
                            </div>
                            <div class="mb-3">
                                <label for="editPromotionEndDate" class="form-label">Data zakończenia promocji</label>
                                <input type="datetime-local" class="form-control" id="editPromotionEndDate">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container">
        <h1 class="mb-4">Panel Administratora</h1>
        
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#products">Produkty</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#reviews">Opinie</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="products">
                <!-- Formularz dodawania produktu -->
                <div class="product-form">
                    <form id="productForm">
                        <div class="mb-3">
                            <label class="form-label">Typ produktu</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productType" id="steam" value="steam" checked>
                                <label class="form-check-label" for="steam">
                                    Konto Steam
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productType" id="instagram" value="instagram">
                                <label class="form-check-label" for="instagram">
                                    Konto Instagram
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productType" id="facebook" value="facebook">
                                <label class="form-check-label" for="facebook">
                                    Konto Facebook
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="productName" class="form-label">Nazwa produktu</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>

                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Opis produktu</label>
                            <small class="form-text text-muted d-block">Każdą linię opisu zacznij od "✦ ". Przykład:<br>✦ Długa historia<br>✦ Pełna weryfikacja<br>✦ Gwarancja bezpieczeństwa</small>
                            <textarea class="form-control mt-2" id="productDescription" rows="3" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Cena (PLN)</label>
                            <input type="number" class="form-control" id="productPrice" required>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productPromotion" onchange="togglePromotionFields()">
                                <label class="form-check-label" for="productPromotion">
                                    Włącz promocję
                                </label>
                            </div>
                        </div>

                        <div id="promotionFields" style="display: none;">
                            <div class="mb-3">
                                <label for="promotionPrice" class="form-label">Cena promocyjna (PLN)</label>
                                <input type="number" class="form-control" id="promotionPrice">
                            </div>
                            <div class="mb-3">
                                <label for="promotionEndDate" class="form-label">Data zakończenia promocji</label>
                                <input type="datetime-local" class="form-control" id="promotionEndDate">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Dodaj produkt</button>
                    </form>
                </div>

                <!-- Lista wszystkich produktów -->
                <div class="mt-4">
                    <h2>Lista produktów</h2>
                    <div id="productList" class="list-group mt-3">
                        <!-- Tu będą wyświetlane wszystkie produkty -->
                    </div>
                </div>

                <!-- Wyszukiwarka po typie konta -->
                <div class="mt-4">
                    <h2>Wyszukaj konta</h2>
                    <div class="input-group mb-3">
                        <input type="text" id="accountSearchInput" class="form-control" placeholder="Wpisz typ konta (np. steam, facebook, instagram)...">
                    </div>
                    <div id="accountSearchResults" class="list-group mt-3">
                        <!-- Tu będą wyświetlane wyniki wyszukiwania -->
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="reviews">
                <div class="card">
                    <div class="card-header">
                        <h3>Zarządzanie opiniami</h3>
                    </div>
                    <div class="card-body">
                        <div id="reviewsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Domyślne produkty
        const defaultProducts = [
            {
                id: 1,
                type: 'steam',
                name: 'Konto Steam 2009',
                description: 'Stare konto Steam z 2009 roku',
                price: 120
            },
            {
                id: 2,
                type: 'steam',
                name: 'Konto Steam 2019',
                description: 'Konto Steam z 2019 roku',
                price: 50
            },
            {
                id: 3,
                type: 'steam',
                name: 'Konto Steam 2023 prime cs2',
                description: 'Nowe konto Steam z CS2 Prime',
                price: 90
            },
            {
                id: 4,
                type: 'instagram',
                name: 'Konto Instagram 50k Follow',
                description: 'Konto Instagram z 50 tysiącami followersów',
                price: 40
            },
            {
                id: 5,
                type: 'instagram',
                name: 'Konto Instagram 195K Follow',
                description: 'Konto Instagram z 195 tysiącami followersów',
                price: 180
            },
            {
                id: 6,
                type: 'facebook',
                name: 'Konto Facebook 2012',
                description: 'Stare konto Facebook z 2012 roku',
                price: 45
            },
            {
                id: 7,
                type: 'facebook',
                name: 'Konto Facebook 2015',
                description: 'Konto Facebook z 2015 roku',
                price: 35
            },
            {
                id: 8,
                type: 'facebook',
                name: 'Konto Facebook 2018',
                description: 'Konto Facebook z 2018 roku',
                price: 25
            }
        ];

        // Inicjalizacja localStorage przy pierwszym uruchomieniu
        if (!localStorage.getItem('products')) {
            localStorage.setItem('products', JSON.stringify(defaultProducts));
        }

        // Wczytaj produkty z localStorage
        let products = JSON.parse(localStorage.getItem('products'));

        let productDataToAdd = null;
        let productToEdit = null;
        let productToDelete = null;
        const adminModal = new bootstrap.Modal(document.getElementById('adminPasswordModal'));
        const editProductModal = new bootstrap.Modal(document.getElementById('editProductModal'));

        function togglePromotionFields() {
            const promotionFields = document.getElementById('promotionFields');
            const isPromotionEnabled = document.getElementById('productPromotion').checked;
            promotionFields.style.display = isPromotionEnabled ? 'block' : 'none';
        }

        function toggleEditPromotionFields() {
            const promotionFields = document.getElementById('editPromotionFields');
            const isPromotionEnabled = document.getElementById('editProductPromotion').checked;
            promotionFields.style.display = isPromotionEnabled ? 'block' : 'none';
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productType = document.querySelector('input[name="productType"]:checked').value;
            const productName = document.getElementById('productName').value;
            const productDescription = document.getElementById('productDescription').value;
            const productPrice = document.getElementById('productPrice').value;
            const isPromotionEnabled = document.getElementById('productPromotion').checked;

            productDataToAdd = {
                id: Date.now(),
                type: productType,
                name: productName,
                description: productDescription,
                price: parseFloat(productPrice),
                promotion: isPromotionEnabled ? {
                    enabled: true,
                    price: parseFloat(document.getElementById('promotionPrice').value),
                    endDate: document.getElementById('promotionEndDate').value
                } : null
            };

            document.getElementById('adminActionType').value = 'add';
            adminModal.show();
        });

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            productToEdit = product;
            document.getElementById('adminActionType').value = 'edit';
            adminModal.show();
        }

        async function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            productToDelete = productId;
            document.getElementById('adminActionType').value = 'delete';
            adminModal.show();
        }

        document.getElementById('adminPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPasswordInput').value;
            const actionType = document.getElementById('adminActionType').value;

            if (password === 'admin123') {
                switch(actionType) {
                    case 'add':
                        if (productDataToAdd) {
                            products.push(productDataToAdd);
                            localStorage.setItem('products', JSON.stringify(products));
                            logAdminAction('product_add', {
                                id: productDataToAdd.id,
                                name: productDataToAdd.name,
                                type: productDataToAdd.type
                            });
                            productDataToAdd = null;
                            document.getElementById('productForm').reset();
                            displayProducts();
                        }
                        break;
                    case 'edit':
                        if (productToEdit) {
                            showEditModal(productToEdit);
                        }
                        break;
                    case 'delete':
                        if (productToDelete) {
                            const productToRemove = products.find(p => p.id === productToDelete);
                            if (productToRemove) {
                                try {
                                    // Usuń opinie z bazy danych
                                    const response = await fetch(`/api/reviews/${encodeURIComponent(productToRemove.name)}`, {
                                        method: 'DELETE'
                                    });
                                    
                                    if (!response.ok) {
                                        throw new Error('Błąd podczas usuwania opinii');
                                    }

                                    logAdminAction('product_removed', {
                                        id: productToDelete,
                                        name: productToRemove.name,
                                        type: productToRemove.type
                                    });

                                    // Usuń produkt z localStorage
                                    products = products.filter(p => p.id !== productToDelete);
                                    localStorage.setItem('products', JSON.stringify(products));
                                    productToDelete = null;
                                    displayProducts();
                                } catch (error) {
                                    console.error('Błąd podczas usuwania produktu:', error);
                                    alert('Wystąpił błąd podczas usuwania produktu. Spróbuj ponownie później.');
                                }
                            }
                        }
                        break;
                }
                adminModal.hide();
                document.getElementById('adminPasswordInput').value = '';
            } else {
                alert('Nieprawidłowe hasło!');
            }
        });

        function showEditModal(product) {
            // Wypełnij formularz edycji danymi produktu
            document.getElementById('editProductType').value = product.type;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductDescription').value = product.description;
            document.getElementById('editProductPrice').value = product.price;

            if (product.promotion && product.promotion.enabled) {
                document.getElementById('editProductPromotion').checked = true;
                document.getElementById('editPromotionPrice').value = product.promotion.price;
                document.getElementById('editPromotionEndDate').value = product.promotion.endDate;
                document.getElementById('editPromotionFields').style.display = 'block';
            } else {
                document.getElementById('editProductPromotion').checked = false;
                document.getElementById('editPromotionFields').style.display = 'none';
            }

            // Pokaż modal edycji
            const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
            editModal.show();
        }

        document.getElementById('editProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const index = products.findIndex(p => p.id === productToEdit.id);
            if (index === -1) return;

            const updatedProduct = {
                ...productToEdit,
                type: document.getElementById('editProductType').value,
                name: document.getElementById('editProductName').value,
                description: document.getElementById('editProductDescription').value,
                price: parseFloat(document.getElementById('editProductPrice').value),
                promotion: document.getElementById('editProductPromotion').checked ? {
                    enabled: true,
                    price: parseFloat(document.getElementById('editPromotionPrice').value),
                    endDate: document.getElementById('editPromotionEndDate').value
                } : null
            };

            products[index] = updatedProduct;
            localStorage.setItem('products', JSON.stringify(products));
            
            logAdminAction('product_edit', {
                id: updatedProduct.id,
                name: updatedProduct.name,
                type: updatedProduct.type,
                changes: {
                    oldName: productToEdit.name,
                    oldType: productToEdit.type,
                    oldPrice: productToEdit.price
                }
            });

            productToEdit = null;
            displayProducts();

            // Zamknij modal edycji
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
            editModal.hide();
        });

        // Funkcja do sprawdzania i aktualizowania statusu promocji
        function checkAndUpdatePromotions() {
            const currentDate = new Date();
            let hasChanges = false;

            products = products.map(product => {
                if (product.promotion && product.promotion.enabled) {
                    const endDate = new Date(product.promotion.endDate);
                    if (endDate <= currentDate) {
                        // Promocja wygasła
                        product.promotion = null;
                        hasChanges = true;
                    }
                }
                return product;
            });

            if (hasChanges) {
                localStorage.setItem('products', JSON.stringify(products));
            }
        }

        function displayProducts() {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            
            // Sprawdź i zaktualizuj status promocji przed wyświetleniem
            checkAndUpdatePromotions();
            
            // Wyświetl wszystkie produkty
            products.forEach(addProductToList);
        }

        function addProductToList(product) {
            const productList = document.getElementById('productList');
            const productElement = document.createElement('div');
            productElement.className = 'list-group-item';
            
            let priceDisplay = `${product.price} PLN`;
            if (product.promotion && product.promotion.enabled) {
                const endDate = new Date(product.promotion.endDate);
                if (endDate > new Date()) {
                    priceDisplay = `
                        <span style="text-decoration: line-through;">${product.price} PLN</span>
                        <span style="color: red; margin-left: 10px;">${product.promotion.price} PLN</span>
                        <br>
                        <small style="color: #666;">Promocja do: ${endDate.toLocaleString()}</small>
                    `;
                }
            }

            // Formatowanie opisu produktu - zamiana ✦ na nowe linie
            const formattedDescription = product.description
                .split('✦')
                .filter(line => line.trim() !== '')
                .map(line => '✦' + line)
                .join('<br>');

            productElement.innerHTML = `
                <h5>${product.name} 
                    <span class="delete-btn" onclick="deleteProduct(${product.id})">❌</span>
                    <span class="edit-btn" onclick="editProduct(${product.id})">✏️</span>
                </h5>
                <p><strong>Typ:</strong> ${product.type === 'steam' ? 'Steam' : product.type === 'instagram' ? 'Instagram' : 'Facebook'}</p>
                <p><strong>Opis:</strong><br>${formattedDescription}</p>
                <p><strong>Cena:</strong> ${priceDisplay}</p>
            `;
            productList.appendChild(productElement);
            productElement.style.opacity = '0';
            setTimeout(() => {
                productElement.style.opacity = '1';
            }, 10);
        }

        // Funkcja wyszukująca konta po typie
        function searchAccounts() {
            const searchText = document.getElementById('accountSearchInput').value.toLowerCase();
            const resultsContainer = document.getElementById('accountSearchResults');
            resultsContainer.innerHTML = '';
            
            if (!searchText) {
                return;
            }

            const filteredProducts = products.filter(product => 
                product.type.toLowerCase().includes(searchText)
            );

            filteredProducts.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'list-group-item';
                
                let priceDisplay = `${product.price} PLN`;
                if (product.promotion && product.promotion.enabled) {
                    const endDate = new Date(product.promotion.endDate);
                    if (endDate > new Date()) {
                        priceDisplay = `
                            <span style="text-decoration: line-through;">${product.price} PLN</span>
                            <span style="color: red; margin-left: 10px;">${product.promotion.price} PLN</span>
                            <br>
                            <small style="color: #666;">Promocja do: ${endDate.toLocaleString()}</small>
                        `;
                    }
                }

                const formattedDescription = product.description
                    .split('✦')
                    .filter(line => line.trim() !== '')
                    .map(line => '✦' + line)
                    .join('<br>');

                productElement.innerHTML = `
                    <h5>${product.name}</h5>
                    <p><strong>Typ:</strong> ${product.type === 'steam' ? 'Steam' : product.type === 'instagram' ? 'Instagram' : 'Facebook'}</p>
                    <p><strong>Opis:</strong><br>${formattedDescription}</p>
                    <p><strong>Cena:</strong> ${priceDisplay}</p>
                `;
                resultsContainer.appendChild(productElement);
            });

            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = '<div class="list-group-item">Nie znaleziono kont tego typu.</div>';
            }
        }

        // Nasłuchiwanie zmian w polu wyszukiwania kont
        document.getElementById('accountSearchInput').addEventListener('input', searchAccounts);

        // Wyświetl produkty przy starcie strony
        document.addEventListener('DOMContentLoaded', () => {
            displayProducts();
        });

        // Obsługa przełączania motywu
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        // Sprawdź zapisany motyw
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-bs-theme', savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Aktualizuj ikonę przycisku
            themeToggle.innerHTML = `<i class="bi bi-${newTheme === 'light' ? 'sun' : 'moon-stars'}"></i> Zmień motyw`;
        });

        // System logowania działań
        const adminLogs = JSON.parse(localStorage.getItem('adminLogs') || '[]');

        function logAdminAction(action, details) {
            const log = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details
            };
            adminLogs.push(log);
            localStorage.setItem('adminLogs', JSON.stringify(adminLogs));
        }

        // System kopii zapasowych
        function createBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                products: products,
                logs: adminLogs
            };
            const backups = JSON.parse(localStorage.getItem('backups') || '[]');
            backups.push(backup);
            // Zachowaj maksymalnie 10 ostatnich kopii
            if (backups.length > 10) {
                backups.shift();
            }
            localStorage.setItem('backups', JSON.stringify(backups));
            return backup;
        }

        function restoreBackup(timestamp) {
            const backups = JSON.parse(localStorage.getItem('backups') || '[]');
            const backup = backups.find(b => b.timestamp === timestamp);
            if (backup) {
                products = backup.products;
                localStorage.setItem('products', JSON.stringify(products));
                displayProducts();
                return true;
            }
            return false;
        }

        // Dodaj przycisk kopii zapasowej do interfejsu
        const backupButton = document.createElement('button');
        backupButton.className = 'btn btn-secondary ms-2';
        backupButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Kopia zapasowa';
        backupButton.onclick = () => {
            const backup = createBackup();
            logAdminAction('backup_created', { timestamp: backup.timestamp });
            alert('Utworzono kopię zapasową!');
        };
        document.querySelector('.theme-switch').appendChild(backupButton);

        // Modyfikacja istniejących funkcji, aby dodać logowanie
        const originalAddProductToList = addProductToList;
        addProductToList = (product) => {
            originalAddProductToList(product);
            logAdminAction('product_added', {
                id: product.id,
                name: product.name,
                type: product.type
            });
        };

        const originalDeleteProduct = deleteProduct;
        deleteProduct = (productId) => {
            const product = products.find(p => p.id === productId);
            if (product) {
                logAdminAction('product_deleted', {
                    id: productId,
                    name: product.name,
                    type: product.type
                });
            }
            originalDeleteProduct(productId);
        };

        // Dodaj przycisk do wyświetlania logów
        const logsButton = document.createElement('button');
        logsButton.className = 'btn btn-info ms-2';
        logsButton.innerHTML = '<i class="bi bi-journal-text"></i> Logi';
        logsButton.onclick = () => {
            const logsHtml = adminLogs.map(log => `
                <div class="log-entry">
                    <strong>${new Date(log.timestamp).toLocaleString()}</strong>
                    <br>
                    Akcja: ${log.action}
                    <br>
                    Szczegóły: ${JSON.stringify(log.details)}
                </div>
            `).join('<hr>');
            
            const modal = new bootstrap.Modal(document.getElementById('logsModal'));
            document.getElementById('logsContent').innerHTML = logsHtml;
            modal.show();
        };
        document.querySelector('.theme-switch').appendChild(logsButton);

        // Dodaj modal do wyświetlania logów
        const logsModal = document.createElement('div');
        logsModal.className = 'modal fade';
        logsModal.id = 'logsModal';
        logsModal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Logi administratora</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="logsContent" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> Wyczyść logi
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(logsModal);

        // Funkcja do czyszczenia logów
        function clearLogs() {
            if (confirm('Czy na pewno chcesz wyczyścić wszystkie logi? Tej operacji nie można cofnąć.')) {
                adminLogs.length = 0; // Wyczyść tablicę logów
                localStorage.setItem('adminLogs', JSON.stringify(adminLogs));
                document.getElementById('logsContent').innerHTML = '<p>Brak logów do wyświetlenia.</p>';
                logAdminAction('logs_cleared', { timestamp: new Date().toISOString() });
            }
        }

        // Funkcja do wyświetlania opinii
        async function displayReviews() {
            const reviewsList = document.getElementById('reviewsList');
            
            try {
                // Pobierz wszystkie produkty
                const products = JSON.parse(localStorage.getItem('products')) || [];
                
                // Pobierz opinie dla każdego produktu
                const allReviews = [];
                for (const product of products) {
                    const response = await fetch(`/api/reviews/${encodeURIComponent(product.name)}`);
                    if (!response.ok) throw new Error('Błąd podczas pobierania opinii');
                    const reviews = await response.json();
                    allReviews.push(...reviews.map(review => ({
                        ...review,
                        productName: product.name
                    })));
                }

                if (allReviews.length === 0) {
                    reviewsList.innerHTML = '<p>Brak opinii do wyświetlenia.</p>';
                    return;
                }

                // Sortuj opinie od najnowszych
                allReviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                reviewsList.innerHTML = allReviews.map(review => `
                    <div class="review-box">
                        <button class="delete-review" onclick="deleteReview('${review._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <h4>${review.productName}</h4>
                        <div class="stars">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                        </div>
                        <p>${review.content}</p>
                        <div class="review-date">${new Date(review.createdAt).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Błąd podczas wyświetlania opinii:', error);
                reviewsList.innerHTML = '<p>Wystąpił błąd podczas ładowania opinii.</p>';
            }
        }

        // Funkcja do usuwania opinii
        async function deleteReview(reviewId) {
            if (confirm('Czy na pewno chcesz usunąć tę opinię?')) {
                try {
                    const response = await fetch(`/api/reviews/single/${reviewId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Błąd podczas usuwania opinii');
                    }

                    displayReviews();
                    logAdminAction('review_removed', { reviewId });
                } catch (error) {
                    console.error('Błąd podczas usuwania opinii:', error);
                    alert('Wystąpił błąd podczas usuwania opinii. Spróbuj ponownie później.');
                }
            }
        }

        // Wyświetl opinie przy załadowaniu strony
        document.addEventListener('DOMContentLoaded', () => {
            displayProducts();
            displayReviews();
        });

        // Obsługa przełączania zakładek
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                const targetId = this.getAttribute('href').substring(1);
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                document.getElementById(targetId).classList.add('show', 'active');
            });
        });
    </script>
</body>
</html> 